<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Flask + PostGIS Demo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: system-ui, Arial; padding: 24px; }
    #map { width: 100%; height: 500px; margin-top: 24px; }
    table { border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 6px; }
  </style>
</head>
<body>
  <h1>✅ Service is running</h1>
  <div id="out">Loading...</div>
  <div id="map"></div>

  <script>
    window.onload = function() {
      fetch('/api/places')
        .then(r => r.json())
        .then(data => {
          // ---- Tabelle ----
          if (!Array.isArray(data) || data.length === 0) {
            document.getElementById('out').textContent = 'No data.';
            return;
          }
          let html = '<table><thead><tr>';
          for (const key of Object.keys(data[0])) html += `<th>${key}</th>`;
          html += '</tr></thead><tbody>';
          for (const row of data) {
            html += '<tr>';
            for (const key of Object.keys(row)) html += `<td>${row[key]}</td>`;
            html += '</tr>';
          }
          html += '</tbody></table>';
          document.getElementById('out').innerHTML = html;

          // ---- Leaflet-Karte ----
          const map = L.map('map');

          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
          }).addTo(map);

          const bounds = [];
          data.forEach(place => {
            const coords = JSON.parse(place.geom).coordinates;
            const lat = coords[1];
            const lng = coords[0];
            L.marker([lat, lng]).addTo(map).bindPopup(`<b>${place.name}</b>`);
            bounds.push([lat, lng]);
          });

          if (bounds.length) map.fitBounds(bounds);
        })
        .catch(e => {
          document.getElementById('out').textContent = 'Failed to fetch /api/places: ' + e;
        });
    }
  </script>
</body>
</html>
