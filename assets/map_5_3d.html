<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>3D Geländemodell (Cesium)</title>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.130/Build/Cesium/Cesium.js"></script>
  <style>
    html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; overflow:hidden; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; }
    #notice { position: absolute; top: 8px; left: 8px; z-index: 1000; background: rgba(255,255,255,0.9); padding:6px 8px; border-radius:6px; font-size:13px; }
  </style>
</head>
<body>
  <div id="notice">3D-Ansicht: Geländemodell (Cesium). Klicke, um in voller Größe zu öffnen.</div>
  <div id="cesiumContainer"></div>

  <script>
    // Robust initialization: do not auto-init Cesium inside a very small iframe.
    // Provide a start button and fallback to opening in a new tab if WebGL/context errors occur.
    (function () {
      const NOTICE = document.getElementById('notice');
      const MIN_HEIGHT = 360; // minimum height in px for safe Cesium init inside iframe
      let viewer = null;
      let started = false;

      function showNotice(html) {
        NOTICE.innerHTML = html;
      }

      function openInNewTab() {
        window.open(window.location.href, '_blank');
      }

      async function initCesium() {
        if (started) return;
        started = true;
        showNotice('Initialisiere 3D-Viewer…');

        try {
          // optional: Cesium.Ion.defaultAccessToken = 'YOUR_TOKEN_HERE';

          viewer = new Cesium.Viewer('cesiumContainer', {
            shadows: false,
            geocoder: false,
            baseLayerPicker: false
          });

          // Add OSM basemap
          const osm = new Cesium.OpenStreetMapImageryProvider({ url: 'https://a.tile.openstreetmap.org/' });
          viewer.imageryLayers.addImageryProvider(osm);

          // Optional WMS for Germany (best-effort)
          try {
            const provider = new Cesium.WebMapServiceImageryProvider({
              url: 'https://sgx.geodatenzentrum.de/wms_basemapde?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetCapabilities',
              layers: 'de_basemapde_web_raster_farbe',
              parameters: { transparent: true, format: 'image/png' }
            });
            viewer.imageryLayers.addImageryProvider(provider);
          } catch (err) {
            console.warn('WMS provider konnte nicht geladen werden:', err);
          }

          // Camera
          viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(10.277367, 47.415311, 3500.0),
            orientation: { heading: Cesium.Math.toRadians(50.0), pitch: Cesium.Math.toRadians(-40.0), roll: 0.0 }
          });

          // Add terrain
          window.startup = async function (Cesium) {
            'use strict';
            try {
              const terr = await Cesium.CesiumTerrainProvider.fromUrl('https://sgx.geodatenzentrum.de/gdz_basemapde_3d_gelaende/dgm5_4326_mesh/');
              viewer.terrainProvider = terr;
            } catch (error) {
              console.error(`Error creating terrain: ${error}`);
            }
          };

          // Load terrain when Cesium is available
          if (typeof Cesium !== 'undefined') {
            window.startupCalled = true;
            window.startup(Cesium).catch((error) => {
              'use strict';
              console.error(error);
            });
          }

          // success
          showNotice('3D-Viewer bereit.');
          setTimeout(() => { NOTICE.style.display = 'none'; }, 1200);
        } catch (err) {
          console.error('Cesium init error:', err);
          showNotice('<strong>Fehler beim Starten des 3D-Viewers.</strong> <button id="open_tab">In neuem Tab öffnen</button>');
          document.getElementById('open_tab').addEventListener('click', openInNewTab);
        }
      }

      // If we're inside an iframe and the available height is small, don't init automatically.
      const inIframe = window.self !== window.top;
      const availH = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
      // Allow force-start via URL, e.g. ?autostart=1 (used when embedding in an overlay iframe)
      const params = new URLSearchParams(window.location.search);
      const forceStart = params.get('autostart') === '1';
      if (forceStart) {
        // try to start Cesium immediately inside the iframe
        initCesium();
      } else if (!inIframe && availH >= MIN_HEIGHT) {
        // top-level and enough space: init immediately
        initCesium();
      } else {
        // show a start button + open-in-tab fallback
        showNotice('<strong>3D-Viewer:</strong> Zum Starten klicken oder in neuem Tab öffnen.\n <button id="start3d">3D starten</button> <button id="open_tab">In neuem Tab öffnen</button>');
        document.getElementById('start3d').addEventListener('click', initCesium);
        document.getElementById('open_tab').addEventListener('click', openInNewTab);
      }
    })();

  </script>
</body>
</html>
